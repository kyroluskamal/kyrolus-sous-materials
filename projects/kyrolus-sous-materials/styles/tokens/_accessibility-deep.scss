// =============================================================================
// KYROLUS SOUS MATERIALS - DEEP ACCESSIBILITY UTILITIES
// =============================================================================
// Comprehensive accessibility support:
// - prefers-* media queries
// - Forced colors mode (Windows High Contrast)
// - Focus states and indicators
// - Screen reader utilities
// - Reduced motion/transparency
// - Color blindness considerations
// =============================================================================

@use "sass:map";
@use "primitives" as *;

// =============================================================================
// PREFERS-REDUCED-MOTION
// =============================================================================
// Respect user's motion preferences

// Disable all animations when reduced motion is preferred
@media (prefers-reduced-motion: reduce) {
  .motion-safe {
    animation: none !important;
    transition: none !important;
  }
}

// Only animate when motion is OK
@media (prefers-reduced-motion: no-preference) {
  .motion-reduce {
    animation: none !important;
    transition: none !important;
  }
}

// Classes for conditional animation
.motion-safe\:animate-spin {
  @media (prefers-reduced-motion: no-preference) {
    animation: spin 1s linear infinite;
  }
}

.motion-safe\:animate-pulse {
  @media (prefers-reduced-motion: no-preference) {
    animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
  }
}

.motion-safe\:animate-bounce {
  @media (prefers-reduced-motion: no-preference) {
    animation: bounce 1s infinite;
  }
}

.motion-safe\:transition {
  @media (prefers-reduced-motion: no-preference) {
    transition-property: all;
    transition-timing-function: ease;
    transition-duration: 0.15s;
  }
}

.motion-safe\:transition-transform {
  @media (prefers-reduced-motion: no-preference) {
    transition-property: transform;
    transition-timing-function: ease;
    transition-duration: 0.15s;
  }
}

.motion-safe\:transition-opacity {
  @media (prefers-reduced-motion: no-preference) {
    transition-property: opacity;
    transition-timing-function: ease;
    transition-duration: 0.15s;
  }
}

// =============================================================================
// PREFERS-REDUCED-TRANSPARENCY
// =============================================================================
// Reduce transparency for users who prefer it

@media (prefers-reduced-transparency: reduce) {
  .transparency-safe {
    opacity: 1 !important;
    backdrop-filter: none !important;
  }

  // Replace glassmorphism with solid backgrounds
  .glass,
  .glass-light,
  .glass-dark {
    backdrop-filter: none;
    background: var(--surface) !important;
  }

  // Make overlays more opaque
  .overlay,
  .backdrop {
    background: var(--bg) !important;
    opacity: 0.95 !important;
  }
}

// =============================================================================
// PREFERS-COLOR-SCHEME
// =============================================================================
// System dark/light mode detection utilities

.dark-mode-only {
  display: none;

  @media (prefers-color-scheme: dark) {
    display: initial;
  }
}

.light-mode-only {
  @media (prefers-color-scheme: dark) {
    display: none;
  }
}

// =============================================================================
// PREFERS-CONTRAST
// =============================================================================
// High contrast mode support

@media (prefers-contrast: more) {
  .contrast-more\:border-2 {
    border-width: 2px;
  }

  .contrast-more\:border-black {
    border-color: black;
  }

  .contrast-more\:text-black {
    color: black;
  }

  .contrast-more\:bg-white {
    background-color: white;
  }

  // Increase text contrast
  .contrast-more\:text-high {
    color: black;

    @media (prefers-color-scheme: dark) {
      color: white;
    }
  }
}

@media (prefers-contrast: less) {
  .contrast-less\:opacity-75 {
    opacity: 0.75;
  }

  .contrast-less\:text-muted {
    color: var(--text-muted);
  }
}

// =============================================================================
// FORCED COLORS MODE (Windows High Contrast)
// =============================================================================
// Support for Windows High Contrast mode

@media (forced-colors: active) {
  // Use system colors
  .forced-colors\:border-current {
    border-color: currentColor;
  }

  .forced-colors\:text-current {
    color: currentColor;
  }

  // Ensure visibility
  .forced-colors\:visible {
    forced-color-adjust: none;
    color: CanvasText;
    background: Canvas;
    border-color: CanvasText;
  }

  // Preserve custom colors when needed
  .forced-colors\:preserve {
    forced-color-adjust: none;
  }

  // Let system handle colors
  .forced-colors\:auto {
    forced-color-adjust: auto;
  }

  // Common element fixes for forced colors
  button,
  [role="button"],
  .btn {
    border: 2px solid currentColor;
  }

  a {
    text-decoration: underline;
  }

  // Focus indicators
  *:focus-visible {
    outline: 3px solid Highlight;
    outline-offset: 2px;
  }

  // Selection
  ::selection {
    background: Highlight;
    color: HighlightText;
  }

  // Placeholder text
  ::placeholder {
    color: GrayText;
  }

  // Disabled elements
  :disabled {
    color: GrayText;
    border-color: GrayText;
  }

  // Links
  a:link {
    color: LinkText;
  }

  a:visited {
    color: VisitedText;
  }

  a:active {
    color: ActiveText;
  }
}

// Force color adjust utility
.color-adjust-none {
  forced-color-adjust: none;
}

.color-adjust-auto {
  forced-color-adjust: auto;
}

// =============================================================================
// FOCUS STATES & INDICATORS
// =============================================================================

// Focus visible (keyboard navigation only)
.focus-visible\:outline-none:focus-visible {
  outline: none;
}

.focus-visible\:ring:focus-visible {
  outline: 2px solid var(--primary);
  outline-offset: 2px;
}

.focus-visible\:ring-2:focus-visible {
  outline: 2px solid var(--primary);
  outline-offset: 2px;
}

.focus-visible\:ring-4:focus-visible {
  outline: 4px solid var(--primary);
  outline-offset: 2px;
}

.focus-visible\:ring-offset-2:focus-visible {
  outline-offset: 2px;
}

.focus-visible\:ring-offset-4:focus-visible {
  outline-offset: 4px;
}

// Focus ring colors
.focus-visible\:ring-primary:focus-visible {
  outline-color: var(--primary);
}

.focus-visible\:ring-secondary:focus-visible {
  outline-color: var(--secondary);
}

.focus-visible\:ring-success:focus-visible {
  outline-color: var(--success);
}

.focus-visible\:ring-danger:focus-visible {
  outline-color: var(--danger);
}

.focus-visible\:ring-white:focus-visible {
  outline-color: white;
}

.focus-visible\:ring-black:focus-visible {
  outline-color: black;
}

// Focus within (parent has focused child)
.focus-within\:ring:focus-within {
  outline: 2px solid var(--primary);
  outline-offset: 2px;
}

.focus-within\:border-primary:focus-within {
  border-color: var(--primary);
}

.focus-within\:shadow-lg:focus-within {
  box-shadow: var(--shadow-lg);
}

.focus-within\:bg-surface:focus-within {
  background-color: var(--surface);
}

// Remove default focus for mouse users
.focus-not-visible:focus:not(:focus-visible) {
  outline: none;
}

// =============================================================================
// SCREEN READER UTILITIES
// =============================================================================

// Visually hidden but accessible to screen readers
.sr-only {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border: 0;
}

// Show on focus (for skip links)
.sr-only-focusable:focus,
.sr-only-focusable:active {
  position: static;
  width: auto;
  height: auto;
  padding: inherit;
  margin: inherit;
  overflow: visible;
  clip: auto;
  white-space: normal;
}

// Not screen reader (hide from assistive tech)
.not-sr-only {
  position: static;
  width: auto;
  height: auto;
  padding: 0;
  margin: 0;
  overflow: visible;
  clip: auto;
  white-space: normal;
}

// Announce to screen readers (for dynamic content)
.sr-announce {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  border: 0;
}

// =============================================================================
// ARIA UTILITIES
// =============================================================================

// Hide from accessibility tree
[aria-hidden="true"] {
  pointer-events: none;
  user-select: none;
}

// Expanded state styling
[aria-expanded="false"] + .aria-expand-target {
  display: none;
}

[aria-expanded="true"] + .aria-expand-target {
  display: block;
}

// Selected state
[aria-selected="true"] {
  background-color: var(--primary-light);
  color: var(--primary);
}

// Pressed state (toggle buttons)
[aria-pressed="true"] {
  background-color: var(--primary);
  color: var(--on-primary);
}

// Current page/item
[aria-current="page"],
[aria-current="true"] {
  font-weight: var(--font-semibold);
  color: var(--primary);
}

// Disabled state
[aria-disabled="true"] {
  opacity: 0.5;
  cursor: not-allowed;
  pointer-events: none;
}

// Busy/loading state
[aria-busy="true"] {
  cursor: wait;
}

// Invalid state
[aria-invalid="true"] {
  border-color: var(--danger);
}

// =============================================================================
// SKIP LINKS
// =============================================================================

.skip-link {
  position: absolute;
  top: -100%;
  left: 50%;
  transform: translateX(-50%);
  padding: var(--spacing-2) var(--spacing-4);
  background: var(--primary);
  color: var(--on-primary);
  border-radius: var(--radius-md);
  z-index: 9999;
  transition: top 0.2s ease;

  &:focus {
    top: var(--spacing-2);
  }
}

// =============================================================================
// COLOR BLINDNESS CONSIDERATIONS
// =============================================================================
// Use patterns/icons in addition to color

// Pattern overlays for color-blind friendly indicators
.pattern-success {
  background-image: repeating-linear-gradient(
    45deg,
    transparent,
    transparent 2px,
    rgba(0, 0, 0, 0.1) 2px,
    rgba(0, 0, 0, 0.1) 4px
  );
}

.pattern-warning {
  background-image: repeating-linear-gradient(
    -45deg,
    transparent,
    transparent 4px,
    rgba(0, 0, 0, 0.1) 4px,
    rgba(0, 0, 0, 0.1) 8px
  );
}

.pattern-danger {
  background-image: repeating-linear-gradient(
    90deg,
    transparent,
    transparent 2px,
    rgba(0, 0, 0, 0.15) 2px,
    rgba(0, 0, 0, 0.15) 4px
  );
}

// Status indicators that don't rely solely on color
.status-indicator {
  display: inline-flex;
  align-items: center;
  gap: var(--spacing-2);

  &::before {
    content: "";
    width: 8px;
    height: 8px;
    border-radius: 50%;
  }

  &.status-success::before {
    background: var(--success);
    box-shadow: 0 0 0 2px var(--success-light);
  }

  &.status-warning::before {
    background: var(--warning);
    border: 2px solid var(--warning);
    box-shadow: none;
    border-radius: 0; // Square for distinction
  }

  &.status-danger::before {
    background: var(--danger);
    border-radius: 0;
    transform: rotate(45deg); // Diamond for distinction
  }

  &.status-info::before {
    background: var(--info);
    border-radius: 2px; // Slightly rounded square
  }
}

// =============================================================================
// READABLE TEXT UTILITIES
// =============================================================================

// Optimal reading width
.prose-width {
  max-width: 65ch;
}

// Comfortable line height for reading
.prose-leading {
  line-height: 1.75;
}

// Larger text for readability
.text-readable {
  font-size: 1.125rem;
  line-height: 1.75;
  max-width: 65ch;
}

// =============================================================================
// TOUCH TARGET SIZE
// =============================================================================
// Ensure touch targets are at least 44x44px (WCAG 2.5.5)

.touch-target {
  min-width: 44px;
  min-height: 44px;
}

.touch-target-lg {
  min-width: 48px;
  min-height: 48px;
}

// Expand clickable area without changing visual size
.touch-expand {
  position: relative;

  &::after {
    content: "";
    position: absolute;
    top: -8px;
    right: -8px;
    bottom: -8px;
    left: -8px;
  }
}

// =============================================================================
// PRINT ACCESSIBILITY
// =============================================================================

@media print {
  // Show URLs for links in print
  a[href]::after {
    content: " (" attr(href) ")";
    font-size: 0.8em;
    color: #666;
  }

  // Don't show URL for internal links
  a[href^="#"]::after,
  a[href^="javascript"]::after {
    content: "";
  }

  // Expand abbreviations
  abbr[title]::after {
    content: " (" attr(title) ")";
  }
}

// =============================================================================
// INVERTED COLORS
// =============================================================================

@media (inverted-colors: inverted) {
  .inverted-colors\:invert {
    filter: invert(1);
  }

  // Prevent double-inversion of images
  img,
  video,
  picture {
    filter: invert(1);
  }
}

// =============================================================================
// PREFERS-REDUCED-DATA
// =============================================================================

@media (prefers-reduced-data: reduce) {
  // Hide decorative images
  .decorative-image,
  [role="presentation"] img {
    display: none;
  }

  // Show placeholder instead of heavy media
  .data-heavy {
    display: none;
  }

  .data-heavy-placeholder {
    display: block;
  }
}

// Default state (normal data)
@media (prefers-reduced-data: no-preference) {
  .data-heavy {
    display: block;
  }

  .data-heavy-placeholder {
    display: none;
  }
}
